#!/bin/sh
set -e
CC="gcc"
# This configure file, as well as the Makefile, need to be run trough Cygwin, because of commands and such, so be
# careful to choose the correct GCC compiler. (Cygwin's GCC or the GCC on your Windows)

# The (Path) name for the .a file
LIBPATH="lib"
LIBNAME="libxtcommon.a"
FINALLIBPATH="$LIBPATH/$LIBNAME"

SYSTEM=`uname -s 2>/dev/null`
case "$SYSTEM" in
	Linux*)
		OS_DIR="src/linux"
		CFLAGS="-std=gnu99 -Wall -Wextra -pedantic"
		MACHINE_ARCH=`uname -m`
		if [ "$MACHINE_ARCH" != "x86_64" ]; then
			# Enable large file support if we're not on 64 bit
			CFLAGS="$CFLAGS -D_FILE_OFFSET_BITS=64"
		fi
		;;
	CYGWIN*)
		OS_DIR="src/windows"
		# 1282 is Win XP with SP2
		# 1536 is Windows Vista
		CFLAGS="-std=c99 -Wall -Wextra -pedantic -DWINVER=1536 -D_WIN32_WINNT=1536"
		;;
	*)
		echo 'Unsupported system' 1>&2
		exit 1
		;;
esac

CFLAGS="$CFLAGS $*"
# Strip trailing spaces (see: http://www.cyberciti.biz/tips/bash-shell-parameter-substitution-2.html)
CFLAGS="${CFLAGS%% }"

cat <<EOF >src/generic/_buildopts.c
// Generated by configure
// Do not modify this!

#include <xt/utils.h>

#define expr(x) #x
#define str(x) expr(x)

const struct xtBuildOptions XT_BUILD_OPTIONS = {
	"$CFLAGS",
	"`date +'%Y-%m-%d'`",
	"v" str(XT_VERSION_MAJOR) "." str(XT_VERSION_MINOR),
	XT_VERSION_MAJOR,
	XT_VERSION_MINOR
};
EOF

MAKEFILE="Makefile"
echo Creating cross platform Makefile...
cat << EOF >$MAKEFILE
.PHONY: default install clean

CC=$CC
INCS=-I"include/"
CFLAGS=\$(INCS) $CFLAGS
CXXFLAGS=\$(CFLAGS)

EOF

FILES=`find src/generic $OS_DIR -name "*.c" -o -name "*.cpp"`
printf "OBJECTS =" >>$MAKEFILE
for i in $FILES; do
	printf " \\\\\n\t%s" `echo $i | sed -e 's/c$/o/' | sed -e 's/cpp$/o/'` >>$MAKEFILE
done

cat <<EOF >>$MAKEFILE


default: $FINALLIBPATH \$(OBJECTS)

install: $FINALLIBPATH
	sudo cp -R include/* /usr/include
	sudo cp lib/$LIBNAME /usr/lib

$FINALLIBPATH: \$(OBJECTS)
	mkdir -p $LIBPATH
	ar -cr $FINALLIBPATH \$(OBJECTS)

EOF
for i in $FILES; do
	dirs=$(dirname "${i}"); echo `echo "$dirs/" | sed -e 's/\.\///'``$CC $CFLAGS -MM $INCS $i | sed -e 's/\\\\/ /'` >>$MAKEFILE
	# Print an extra newline
	echo "" >>$MAKEFILE
done
cat <<EOF >>$MAKEFILE
clean:
	rm -f $FINALLIBPATH \$(OBJECTS)
EOF

cd ..

echo 'Makefile generated'
